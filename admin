# -*- coding: utf-8 -*-
import logging
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# üîê Token va kanal username
BOT_TOKEN = "8227620479:AAG8QpNFwwn_d7Maja0vhuUvYcK2bAhxI6A"
CHANNEL_USERNAME = "@Music3_uz"
ACCESS_CODE = "topolmiysan"  # Siz belgilaydigan maxfiy kod

# --- Caption matnlar ---
SONG_TEXT = """„Ö§ „Ö§ ‚áÜ„Ö§     ‚óÅ„Ö§‚ùö‚ùö„Ö§‚ñ∑„Ö§    ‚Üª
00:00 ‚óè‚îÅ‚îÅ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 00:35
üîä ‚ñÅ ‚ñÇ ‚ñÉ ‚ñÑ ‚ñÖ ‚ñÜ ‚ñá ‚ñà 
üéß ùó°ùóòùó™ ùó†ùó®ùó¶ùóúùóñ üîä
·µó·µâÀ°·µâ·µç ≥·µÉ·µê‚û™ @Music3_uz
‚û≥ùô¥ùôΩùô∂ ùöâùô∞ùôºùôæùôΩùô∞ùöÖùô∏ùöà ùöÄùôæ ªùöÇùô∑ùô∏ùöêùôªùô∞ùöÅ ùô±ùô∏ùöâùô≥ùô∞‚òö"""

VOICE_TEXT = """‚áÜ       ‚óÅ„Ö§‚ùö‚ùö„Ö§‚ñ∑„Ö§    ‚Üª
00:00 ‚óè‚îÅ‚îÅ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 00:35
  ‚û≥ ùô¥ùôΩùô∂ ùöâùô∞ùôºùôæùôΩùô∞ùöÖùô∏ùöà‚òö
  ‚û≥ ùöÄùôæ ªùöÇùô∑ùô∏ùöêùôªùô∞ùöÅ ùô±ùô∏ùöâùô≥ùô∞‚òö
   üéµ To'liq Mp3 Pastdaüëá"""

VIDEO_TEXT = """üé¨  ‚àûùêÅùêàùêôùêÉùêÄùêç ùêîùêôùêéùêêùêãùêÄùêíùêáùêåùêÄùêçùêÜ‚àû üåü"""
PHOTO_TEXT = """üñºÔ∏è  ùêÅùêàùêôùêçùêà ùêäùêîùêôùêÄùêìùêàùêÅ ùêÅùêéùêëùêÜùêÄùêçùêãùêÄùêëùêÜùêÄ ùêëùêÄùêóùêåùêÄùêì üì∏"""

# ‚úÖ Kod kiritgan foydalanuvchilar ro‚Äòyxati
allowed_users = set()


def _is_audio_document(mime: str | None) -> bool:
    return bool(mime and mime.startswith("audio/"))


# --- /start komandasi ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if user_id in allowed_users:
        await update.message.reply_text("‚úÖ Siz allaqachon kod kiritgansiz. Media yuborishingiz mumkin.")
        return

    await update.message.reply_text("üîë Kirish uchun kodni kiriting:")


# --- Kod tekshirish ---
async def check_code(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text.strip()

    if user_id in allowed_users:
        return  # Agar foydalanuvchi allaqachon ruxsat olgan bo‚Äòlsa ‚Üí tekshirish shart emas

    if text == ACCESS_CODE:
        allowed_users.add(user_id)
        await update.message.reply_text("‚úÖ Kod to‚Äòg‚Äòri! Endi media yuborishingiz mumkin.")
    else:
        await update.message.reply_text("‚ùå Noto‚Äòg‚Äòri kod! Iltimos, qaytadan /start bosing.")


# --- Media yuborilganda ---
async def send_media(update: Update, context: ContextTypes.DEFAULT_TYPE):
    msg = update.message
    user_id = update.effective_user.id

    # üëÆ Faqat kod kiritganlarga ruxsat
    if user_id not in allowed_users:
        await msg.reply_text("üö´ Avval /start bosib kod kiriting!")
        return

    if not msg:
        return

    try:
        if msg.audio:
            await context.bot.send_audio(CHANNEL_USERNAME, msg.audio.file_id, caption=SONG_TEXT)

        elif msg.document and _is_audio_document(msg.document.mime_type):
            await context.bot.send_audio(CHANNEL_USERNAME, msg.document.file_id, caption=SONG_TEXT)

        elif msg.photo:
            await context.bot.send_photo(CHANNEL_USERNAME, msg.photo[-1].file_id, caption=PHOTO_TEXT)

        elif msg.voice:
            await context.bot.send_voice(CHANNEL_USERNAME, msg.voice.file_id, caption=VOICE_TEXT)

        elif msg.video:
            await context.bot.send_video(CHANNEL_USERNAME, msg.video.file_id, caption=VIDEO_TEXT)

        else:
            await msg.reply_text("‚ùó Faqat media yuboring (audio, rasm, ovoz yoki video).")
            return

        await msg.reply_text("‚úÖ Kanalga post qilindi!")

    except Exception as e:
        logging.exception("Xato: %s", e)
        await msg.reply_text(f"‚ö†Ô∏è Xatolik: {e}")


def main():
    logging.basicConfig(level=logging.INFO)

    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # üîπ Kod tekshirish va start
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, check_code))

    # üîπ Media filtrlash
    media_filters = (
        filters.AUDIO
        | filters.Document.MimeType("audio/mpeg")
        | filters.Document.MimeType("audio/mp4")
        | filters.PHOTO
        | filters.VOICE
        | filters.VIDEO
    )

    app.add_handler(MessageHandler(media_filters, send_media))

    print("ü§ñ Bot ishga tushdi...")
    app.run_polling(allowed_updates=["message"])


if __name__ == "__main__":
    main()
